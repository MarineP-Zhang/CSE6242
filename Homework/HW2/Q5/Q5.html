<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wildlife Trafficking Choropleth Map</title>
    <script src="../lib/d3.v5.min.js"></script>
    <script src="../lib/d3-legend.min.js"></script>
    <script src="../lib/d3-tip.min.js"></script>
    <script src="../lib/topojson.v2.min.js"></script>
    <script src="../lib/d3-geo-projection.v2.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        
        #dropdown-container {
            margin: 20px 0;
        }
        
        .country {
            stroke: #fff;
            stroke-width: 0.5;
        }
        
        .country:hover {
            stroke: #333;
            stroke-width: 1.5;
        }
        
        .d3-tip {
            line-height: 1.4;
            padding: 12px;
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            border-radius: 4px;
            pointer-events: none;
            font-size: 12px;
        }
        
        .legendQuant .label {
            font-size: 12px;
        }
        
        #signature {
            text-align: center;
            margin-top: 20px;
            font-style: italic;
        }
    </style>
</head>
<body>
    <h1>Wildlife Trafficking Incidents by Country</h1>
    
    <div id="dropdown-container">
        <label for="yearDropdown">Select Year: </label>
        <select id="yearDropdown"></select>
    </div>
    
    <svg id="choropleth"></svg>
    
    <div id="signature">mzhang773</div>
    
    <script>
        // Set up dimensions
        const margin = {top: 20, right: 20, bottom: 20, left: 20};
        const width = 960 - margin.left - margin.right;
        const height = 600 - margin.top - margin.bottom;
        
        // Create SVG
        const svg = d3.select("#choropleth")
            .attr("width", width + margin.left + margin.right)
            .attr("height", height + margin.top + margin.bottom);
        
        // Create projection and path
        const projection = d3.geoNaturalEarth1()
            .scale(150)
            .translate([width / 2, height / 2]);
        
        const path = d3.geoPath().projection(projection);
        
        // Create tooltip
        const tip = d3.tip()
            .attr('class', 'd3-tip')
            .attr('id', 'tooltip')
            .offset([-10, 0])
            .html(function(d) { return d; });
        
        svg.call(tip);
        
        // Color scale
        let colorScale;
        
        // Load data
        Promise.all([
            d3.json("data/world_countries.json"),
            d3.csv("data/wildlife_trafficking.csv")
        ]).then(function([worldData, traffickingData]) {
            console.log("Data loaded successfully");
            console.log("Trafficking data rows:", traffickingData.length);
            console.log("First row:", traffickingData[0]);
            
            // Get unique years and sort them
            const years = [...new Set(traffickingData.map(d => +d.Year))].sort((a, b) => a - b);
            console.log("Years found:", years);
            
            // Populate dropdown
            const dropdown = d3.select("#yearDropdown");
            dropdown.selectAll("option")
                .data(years)
                .enter()
                .append("option")
                .attr("value", d => d)
                .text(d => d);
            
            console.log("Dropdown populated with", years.length, "options");
            
            // Organize data by year
            const dataByYear = {};
            traffickingData.forEach(d => {
                const year = +d.Year;
                const country = d["Country of Incident"];
                if (!dataByYear[year]) {
                    dataByYear[year] = {};
                }
                dataByYear[year][country] = {
                    incidents: +d.Number_of_Incidents || 0,
                    avgFine: +d.Average_Fine || 0,
                    avgImprisonment: +d.Average_Imprisonment || 0
                };
            });
            
            // Function to update map
            function updateMap(selectedYear) {
                // Clear existing elements
                svg.selectAll("*").remove();
                svg.call(tip);
                
                // Get data for selected year
                const yearData = dataByYear[selectedYear] || {};
                
                // Get all incident counts for the year (including countries in CSV but not in geoJSON)
                const allCountries = Object.keys(yearData);
                const incidentCounts = allCountries.map(country => yearData[country].incidents);
                
                // Create quantile scale with 4 colors
                colorScale = d3.scaleQuantile()
                    .domain(incidentCounts)
                    .range(["#fee5d9", "#fcae91", "#fb6a4a", "#cb181d"]);
                
                // Create countries group
                const countriesGroup = svg.append("g")
                    .attr("id", "countries");
                
                // Draw countries
                countriesGroup.selectAll("path")
                    .data(worldData.features)
                    .enter()
                    .append("path")
                    .attr("class", "country")
                    .attr("d", path)
                    .attr("fill", function(d) {
                        const countryName = d.properties.name;
                        const data = yearData[countryName];
                        if (data && data.incidents !== undefined) {
                            return colorScale(data.incidents);
                        }
                        return "#ccc";
                    })
                    .on("mouseover", function(d) {
                        const countryName = d.properties.name;
                        const data = yearData[countryName];
                        
                        let tooltipHtml = `<strong>${countryName}</strong><br/>`;
                        tooltipHtml += `Year: ${selectedYear}<br/>`;
                        
                        if (data && data.incidents !== undefined) {
                            tooltipHtml += `Number of Incidents: ${data.incidents}<br/>`;
                            tooltipHtml += `Average Fine (USD): ${data.avgFine > 0 ? data.avgFine.toFixed(2) : 'N/A'}<br/>`;
                            tooltipHtml += `Average Imprisonment (Years): ${data.avgImprisonment > 0 ? data.avgImprisonment.toFixed(2) : 'N/A'}`;
                        } else {
                            tooltipHtml += `Number of Incidents: N/A<br/>`;
                            tooltipHtml += `Average Fine (USD): N/A<br/>`;
                            tooltipHtml += `Average Imprisonment (Years): N/A`;
                        }
                        
                        tip.show(tooltipHtml, this);
                    })
                    .on("mouseout", function() {
                        tip.hide();
                    });
                
                // Add legend if there are incidents
                if (incidentCounts.length > 0) {
                    const legendG = svg.append("g")
                        .attr("id", "legend")
                        .attr("transform", `translate(${width - 150}, ${height - 200})`);
                    
                    const legend = d3.legendColor()
                        .labelFormat(d3.format(".2f"))
                        .scale(colorScale)
                        .shapePadding(5)
                        .shapeWidth(30)
                        .shapeHeight(20);
                    
                    legendG.call(legend);
                }
            }
            
            // Event listener for dropdown
            dropdown.on("change", function() {
                const selectedYear = +this.value;
                updateMap(selectedYear);
            });
            
            // Initial map with first year
            updateMap(years[0]);
        }).catch(function(error) {
            console.error("Error loading data:", error);
            alert("Error loading data files. Please make sure wildlife_trafficking.csv and world_countries.json are in the correct directory.");
        });
    </script>
</body>
</html>